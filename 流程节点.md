#流程节点

[TOC]

```java
package com.mdiaf.monitor.job;

import com.mdiaf.baf.AiafContext;
import com.mdiaf.batch.service.BafJobCommand;
import com.mdiaf.bmf.SObject;
import com.mdiaf.bmf.service.BmfOrmAggrManager;
import com.mdiaf.monitor.constant.ConfigParameterConstant;
import com.mdiaf.monitor.entity.AlarmRecordEntity;
import com.mdiaf.monitor.enums.AlarmTypeEnums;
import com.mdiaf.monitor.genmodel.AlarmDefinition;
import com.mdiaf.monitor.service.AlarmService;
import com.mdiaf.orm.service.BafJobOrmService;
import com.mdiaf.orm.service.util.OrmUtilities;
import com.mdiaf.pas.service.AdminAggrManager;
import com.mdiaf.recon.genmodel.BafJob;
import com.mdiaf.util.BafDateUtils;
import com.mdiaf.util.LogType;
import com.mdiaf.webapp.util.DateUtil;
import org.apache.commons.collections.CollectionUtils;
import org.apache.commons.collections.MapUtils;
import org.apache.commons.lang3.StringUtils;
import org.quartz.JobExecutionContext;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Component;

import java.io.Serializable;
import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.Set;

@Component
public class MonitorTimestampItemRecognitionErrorScanJob implements BafJobCommand {


    @Autowired
    private AlarmService alarmService;

    @Autowired
    private AdminAggrManager adminAggrManager;

    @Autowired
    private BmfOrmAggrManager bmfOrmAggrManager;

    @Autowired
    private RedisTemplate<Serializable, Serializable> redisTemplate;

    private final Logger log = LoggerFactory.getLogger(LogType.JOB);

    @Autowired
    private JdbcTemplate jdbcTemplate;

    @Override
    public String getJobInstKey(Object jobParameters, SObject jobId) throws Exception {
        if (StringUtils.isNotEmpty((String) jobParameters)) { //Should of format yyyy-MM-dd
            //jobTime = BafDateUtils.parseDate((String) jobParameters);
            return (String) jobParameters;
        }

        Date jobTime = new Date();

        String currentJobEndTime = BafDateUtils.formatDate(jobTime, BafDateUtils.SYS_DEFAULT_DATE_FORMAT_STRING2);

        return currentJobEndTime;
    }

    @Override
    public void execute(JobExecutionContext context) throws Exception {
        try {
            List<AlarmDefinition> alarmDefinitionList = alarmService.getAlarmDefinitionListByAlarmType(AlarmTypeEnums.TimestampItemRecognitionError);
            for (final AlarmDefinition alarmDefinition : alarmDefinitionList) {
                new Thread(alarmDefinition.getAlarmCode()) {
                    public void run() {
                        log.debug("Thread: " + getName() + "running");
                        process(alarmDefinition);
                    }
                }.start();
            }
        } catch (Exception e) {
            log.error("监控流程状态时间节点未生成Job异常：{}", e.getMessage(), e);
        }
    }

    private void process(AlarmDefinition alarmDefinition) {
        // 1.获取并计算时间段，取该时间段内的数据
        Date endTime = new Date();
        int intervalTime = adminAggrManager.getConfigParameterValue(ConfigParameterConstant.WorkflowProcess_TimestampItemNotCreated_CHECKING_INTERVAL, 1);
        Date startTime = DateUtil.addMinute(endTime, -intervalTime);
        String startTimeStampStr = BafDateUtils.formatTimestamp(startTime);
        String endTimeStampStr = BafDateUtils.formatTimestamp(endTime);

        // 2.获取OUT节点列表
        String outSql = "Select workFlowId, recordTime From bl_time_record_item Where itemCode = 'outEmergencyDate' and recordTime >='" + startTimeStampStr + "' and recordTime <='" + endTimeStampStr
                + "' and recordTime is not null";

        List<Map<String, Object>> outItemList = bmfOrmAggrManager.builder(jdbcTemplate).queryForList(outSql);
        if (CollectionUtils.isNotEmpty(outItemList)) {
            for (Map<String, Object> itemMap : outItemList) {
                Long workFlowIdOfOut = (Long) itemMap.get("workFlowId"); // 工作流ID:JdbcType:bigint
                Date recordTimeOfOut = (Date) itemMap.get("recordTime");// 日期:JdbcType:varchar
                Date outEmergencyDate = (Date) redisTemplate.opsForHash().get("outEmergencyDate", workFlowIdOfOut);
                if (outEmergencyDate == null) {
                    redisTemplate.opsForHash().put("outEmergencyDate", workFlowIdOfOut, recordTimeOfOut);
                }
            }
        }

        // 3.获取CCU节点列表
        String ccuSql = "Select workFlowId, recordTime From bl_time_record_item Where itemCode = 'ccuArrivalDate' and recordTime >='" + startTimeStampStr + "' and recordTime <='" + endTimeStampStr
                + "' and recordTime is not null ";

        List<Map<String, Object>> ccuItemList = bmfOrmAggrManager.builder(jdbcTemplate).queryForList(ccuSql);

        if (CollectionUtils.isNotEmpty(ccuItemList)) {
            for (Map<String, Object> ccuMap : ccuItemList) {
                Long workFlowIdOfCCU = (Long) ccuMap.get("workFlowId");
                Date recordTime = (Date) ccuMap.get("recordTime");

                Date recordTimeFromCache = (Date) redisTemplate.opsForHash().get("outEmergencyDate", workFlowIdOfCCU);
                // OUT节点能够匹配到缓存数据
                if (recordTimeFromCache != null) {
                    // 节点超时
                    if (DateUtil.addMinute(recordTimeFromCache, 4).before(recordTime)) {
                        // 清除缓存
                        redisTemplate.opsForHash().delete("outEmergencyDate", workFlowIdOfCCU);
                        // 持久化
                        AlarmRecordEntity alarmRecordEntity = new AlarmRecordEntity();
                        alarmRecordEntity.setObjectCode(String.valueOf(workFlowIdOfCCU));
                        alarmRecordEntity.setObjectType("workFlow");
                        alarmRecordEntity.setAlarmStatus("Created");
                        alarmRecordEntity.setSendStatus(0);
                        alarmRecordEntity.setAlarmSource("NODATE");
                        alarmRecordEntity.setAlarmStartTime(endTime);
                        alarmRecordEntity.setAlarmEndTime(endTime);

                        alarmService.addAlarmRecord(alarmDefinition, alarmRecordEntity);
                    } else {
                        // 清除缓存
                        redisTemplate.opsForHash().delete("outEmergencyDate", workFlowIdOfCCU);
                    }
                }
            }
        }

        // 4.CCU节点列表无数据，或有数据但缓存全部未匹配或者部分未匹配：
        // Date now = new Date();
        Map<Object, Object> allOutEmergencyDateCache = redisTemplate.opsForHash().entries("outEmergencyDate");
        if (MapUtils.isNotEmpty(allOutEmergencyDateCache)) {
            Set<Map.Entry<Object, Object>> entries = allOutEmergencyDateCache.entrySet();
            for (Map.Entry<Object, Object> entry : entries) {
                Long workFlowIdFromCache = (Long) entry.getKey();
                Date recordTimeFromCache = (Date) entry.getValue();
                // 超时未生成
                if (DateUtil.addMinute(recordTimeFromCache, 4).before(endTime)) {
                    // 清除缓存
                    redisTemplate.opsForHash().delete("outEmergencyDate", workFlowIdFromCache);
                    // 持久化
                    AlarmRecordEntity alarmRecordEntity = new AlarmRecordEntity();
                    alarmRecordEntity.setObjectCode(String.valueOf(workFlowIdFromCache));
                    alarmRecordEntity.setObjectType("workFlow");
                    alarmRecordEntity.setAlarmStatus("Created");
                    alarmRecordEntity.setSendStatus(0);
                    alarmRecordEntity.setAlarmSource("NODATE");
                    alarmRecordEntity.setAlarmStartTime(endTime);
                    alarmRecordEntity.setAlarmEndTime(endTime);

                    alarmService.addAlarmRecord(alarmDefinition, alarmRecordEntity);
                }
            }
        }
    }

    @Override
    public List<String> getMissedJobs(Long jobId) {
        //List<String> jobKeys = Lists.newArrayList();

        getLastSuccessJobInstKey(jobId);
        return null;
    }

    private String getLastSuccessJobInstKey(Long jobId) {
        OrmUtilities.modifyBegin();
        BafJobOrmService bafJobOrmService = AiafContext.getBean(BafJobOrmService.class);
        BafJob bafJob = bafJobOrmService.findOneById(jobId);
        String result = bafJob == null ? null : bafJob.getLastSuccessJobKey();
        OrmUtilities.modifyEnd();

        return result;
    }

}

```





** recordValue版本 **

```java
package com.mdiaf.monitor.job;

import com.mdiaf.baf.AiafContext;
import com.mdiaf.batch.service.BafJobCommand;
import com.mdiaf.bmf.SObject;
import com.mdiaf.bmf.service.BmfOrmAggrManager;
import com.mdiaf.monitor.constant.ConfigParameterConstant;
import com.mdiaf.monitor.entity.AlarmRecordEntity;
import com.mdiaf.monitor.enums.AlarmTypeEnums;
import com.mdiaf.monitor.genmodel.AlarmDefinition;
import com.mdiaf.monitor.service.AlarmService;
import com.mdiaf.orm.service.BafJobOrmService;
import com.mdiaf.orm.service.util.OrmUtilities;
import com.mdiaf.pas.service.AdminAggrManager;
import com.mdiaf.recon.genmodel.BafJob;
import com.mdiaf.util.BafDateUtils;
import com.mdiaf.util.LogType;
import com.mdiaf.webapp.util.DateUtil;
import org.apache.commons.collections.CollectionUtils;
import org.apache.commons.collections.MapUtils;
import org.apache.commons.lang3.StringUtils;
import org.quartz.JobExecutionContext;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Component;

import java.io.Serializable;
import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.Set;

@Component
public class MonitorTimestampItemRecognitionErrorScanJob implements BafJobCommand {


    @Autowired
    private AlarmService alarmService;

    @Autowired
    private AdminAggrManager adminAggrManager;

    @Autowired
    private BmfOrmAggrManager bmfOrmAggrManager;

    @Autowired
    private RedisTemplate<Serializable, Serializable> redisTemplate;

    private final Logger log = LoggerFactory.getLogger(LogType.JOB);

    @Autowired
    private JdbcTemplate jdbcTemplate;

    @Override
    public String getJobInstKey(Object jobParameters, SObject jobId) throws Exception {
        if (StringUtils.isNotEmpty((String) jobParameters)) { //Should of format yyyy-MM-dd
            //jobTime = BafDateUtils.parseDate((String) jobParameters);
            return (String) jobParameters;
        }

        Date jobTime = new Date();

        String currentJobEndTime = BafDateUtils.formatDate(jobTime, BafDateUtils.SYS_DEFAULT_DATE_FORMAT_STRING2);

        return currentJobEndTime;
    }

    @Override
    public void execute(JobExecutionContext context) throws Exception {
        try {
            List<AlarmDefinition> alarmDefinitionList = alarmService.getAlarmDefinitionListByAlarmType(AlarmTypeEnums.TimestampItemRecognitionError);
            for (final AlarmDefinition alarmDefinition : alarmDefinitionList) {
                new Thread(alarmDefinition.getAlarmCode()) {
                    public void run() {
                        log.debug("Thread: " + getName() + "running");
                        process(alarmDefinition);
                    }
                }.start();
            }
        } catch (Exception e) {
            log.error("监控流程状态时间节点未生成Job异常：{}", e.getMessage(), e);
        }
    }

    private void process(AlarmDefinition alarmDefinition) {
        // 1.获取并计算时间段，取该时间段内的数据
        Date endTime = new Date();
        int intervalTime = adminAggrManager.getConfigParameterValue(ConfigParameterConstant.WorkflowProcess_TimestampItemNotCreated_CHECKING_INTERVAL, 1);
        Date startTime = DateUtil.addMinute(endTime, -intervalTime);
        String startTimeStampStr = BafDateUtils.formatTimestamp(startTime);
        String endTimeStampStr = BafDateUtils.formatTimestamp(endTime);

        // 2.获取OUT节点列表
        String outSql = "Select workFlowId, recordValue From bl_time_record_item Where itemCode = 'outEmergencyDate' and recordTime >='" + startTimeStampStr + "' and recordTime <='" + endTimeStampStr
                + "' and recordTime is not null";

        List<Map<String, Object>> outItemList = bmfOrmAggrManager.builder(jdbcTemplate).queryForList(outSql);
        if (CollectionUtils.isNotEmpty(outItemList)) {
            for (Map<String, Object> outMap : outItemList) {
                Long workFlowIdOfOut = (Long) outMap.get("workFlowId"); // 工作流ID:JdbcType:bigint
                Date recordValue = new Date(Long.valueOf((String)outMap.get("recordValue"))); // jdbcType(varchar)-->String--->Long--->Date

                Date recordTimeOfOut = (Date) outMap.get("recordTime");// 日期:JdbcType:varchar
                Date outEmergencyDate = (Date) redisTemplate.opsForHash().get("outEmergencyDate", workFlowIdOfOut);
                if (outEmergencyDate == null) {
                    redisTemplate.opsForHash().put("outEmergencyDate", workFlowIdOfOut, recordTimeOfOut);
                }
            }
        }

        // 3.获取CCU节点列表
        String ccuSql = "Select workFlowId, recordValue From bl_time_record_item Where itemCode = 'ccuArrivalDate' and recordTime >='" + startTimeStampStr + "' and recordTime <='" + endTimeStampStr
                + "' and recordTime is not null ";

        List<Map<String, Object>> ccuItemList = bmfOrmAggrManager.builder(jdbcTemplate).queryForList(ccuSql);

        if (CollectionUtils.isNotEmpty(ccuItemList)) {
            for (Map<String, Object> ccuMap : ccuItemList) {
                Long workFlowIdOfCCU = (Long) ccuMap.get("workFlowId");
                Date recordValue = new Date(Long.valueOf((String)ccuMap.get("recordValue"))); // jdbcType(varchar)-->String--->Long--->Date
                Date recordTimeFromCache = (Date) redisTemplate.opsForHash().get("outEmergencyDate", workFlowIdOfCCU);
                // OUT节点能够匹配到缓存数据
                if (recordTimeFromCache != null) {
                    // 节点超时
                    if (DateUtil.addMinute(recordTimeFromCache, 4).before(recordValue)) {
                        // 清除缓存
                        redisTemplate.opsForHash().delete("outEmergencyDate", workFlowIdOfCCU);
                        // 持久化
                        AlarmRecordEntity alarmRecordEntity = new AlarmRecordEntity();
                        alarmRecordEntity.setObjectCode(String.valueOf(workFlowIdOfCCU));
                        alarmRecordEntity.setObjectType("workFlow");
                        alarmRecordEntity.setAlarmStatus("Created");
                        alarmRecordEntity.setSendStatus(0);
                        alarmRecordEntity.setAlarmSource("NODATE");
                        alarmRecordEntity.setAlarmStartTime(endTime);
                        alarmRecordEntity.setAlarmEndTime(endTime);

                        alarmService.addAlarmRecord(alarmDefinition, alarmRecordEntity);
                    } else {
                        // 清除缓存
                        redisTemplate.opsForHash().delete("outEmergencyDate", workFlowIdOfCCU);
                    }
                }
            }
        }

        // 4.CCU节点列表无数据，或有数据但缓存全部未匹配或者部分未匹配：
        // Date now = new Date();
        Map<Object, Object> allOutEmergencyDateCache = redisTemplate.opsForHash().entries("outEmergencyDate");
        if (MapUtils.isNotEmpty(allOutEmergencyDateCache)) {
            Set<Map.Entry<Object, Object>> entries = allOutEmergencyDateCache.entrySet();
            for (Map.Entry<Object, Object> entry : entries) {
                Long workFlowIdFromCache = (Long) entry.getKey();
                Date recordTimeFromCache = (Date) entry.getValue();
                // 超时未生成
                if (DateUtil.addMinute(recordTimeFromCache, 4).before(endTime)) {
                    // 清除缓存
                    redisTemplate.opsForHash().delete("outEmergencyDate", workFlowIdFromCache);
                    // 持久化
                    AlarmRecordEntity alarmRecordEntity = new AlarmRecordEntity();
                    alarmRecordEntity.setObjectCode(String.valueOf(workFlowIdFromCache));
                    alarmRecordEntity.setObjectType("workFlow");
                    alarmRecordEntity.setAlarmStatus("Created");
                    alarmRecordEntity.setSendStatus(0);
                    alarmRecordEntity.setAlarmSource("NODATE");
                    alarmRecordEntity.setAlarmStartTime(endTime);
                    alarmRecordEntity.setAlarmEndTime(endTime);

                    alarmService.addAlarmRecord(alarmDefinition, alarmRecordEntity);
                }
            }
        }
    }

    @Override
    public List<String> getMissedJobs(Long jobId) {
        //List<String> jobKeys = Lists.newArrayList();

        getLastSuccessJobInstKey(jobId);
        return null;
    }

    private String getLastSuccessJobInstKey(Long jobId) {
        OrmUtilities.modifyBegin();
        BafJobOrmService bafJobOrmService = AiafContext.getBean(BafJobOrmService.class);
        BafJob bafJob = bafJobOrmService.findOneById(jobId);
        String result = bafJob == null ? null : bafJob.getLastSuccessJobKey();
        OrmUtilities.modifyEnd();

        return result;
    }

}

```





##BUG版：

```java
package com.mdiaf.monitor.job;

import com.mdiaf.baf.AiafContext;
import com.mdiaf.batch.service.BafJobCommand;
import com.mdiaf.bmf.SObject;
import com.mdiaf.bmf.service.BmfOrmAggrManager;
import com.mdiaf.groovy.GroovyBafBinding;
import com.mdiaf.monitor.constant.ConfigParameterConstant;
import com.mdiaf.monitor.constant.MonitorCacheConstant;
import com.mdiaf.monitor.entity.AlarmRecordEntity;
import com.mdiaf.monitor.enums.AlarmTypeEnums;
import com.mdiaf.monitor.genmodel.AlarmDefinition;
import com.mdiaf.monitor.service.AlarmService;
import com.mdiaf.monitor.service.DeviceService;
import com.mdiaf.orm.service.BafJobOrmService;
import com.mdiaf.orm.service.util.OrmUtilities;
import com.mdiaf.pas.service.AdminAggrManager;
import com.mdiaf.recon.genmodel.BafJob;
import com.mdiaf.util.BafDateUtils;
import com.mdiaf.util.LogType;
import com.mdiaf.webapp.util.DateUtil;
import groovy.lang.Binding;
import groovy.lang.GroovyShell;
import groovy.lang.Script;
import org.apache.commons.collections.CollectionUtils;
import org.apache.commons.lang3.StringUtils;
import org.quartz.JobExecutionContext;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Component;

import java.io.Serializable;
import java.util.*;

@Component
public class MonitorTimestampItemRecognitionErrorScanJob implements BafJobCommand {


    @Autowired
    private AlarmService alarmService;

    @Autowired
    private AdminAggrManager adminAggrManager;

    @Autowired
    private BmfOrmAggrManager bmfOrmAggrManager;

    @Autowired
    private RedisTemplate<Serializable, Serializable> redisTemplate;

    private final Logger log = LoggerFactory.getLogger(LogType.JOB);

    @Autowired
    private JdbcTemplate jdbcTemplate;

    @Override
    public String getJobInstKey(Object jobParameters, SObject jobId) throws Exception {
        if (StringUtils.isNotEmpty((String) jobParameters)) { //Should of format yyyy-MM-dd
            //jobTime = BafDateUtils.parseDate((String) jobParameters);
            return (String) jobParameters;
        }

        Date jobTime = new Date();

        String currentJobEndTime = BafDateUtils.formatDate(jobTime, BafDateUtils.SYS_DEFAULT_DATE_FORMAT_STRING2);

        return currentJobEndTime;
    }

    @Override
    public void execute(JobExecutionContext context) throws Exception {
        try {
            List<AlarmDefinition> alarmDefinitionList = alarmService.getAlarmDefinitionListByAlarmType(AlarmTypeEnums.TimestampItemRecognitionError);
            for (final AlarmDefinition alarmDefinition : alarmDefinitionList) {
                new Thread(alarmDefinition.getAlarmCode()) {
                    public void run() {
                        log.debug("Thread: " + getName() + "running");
                        process(alarmDefinition);
                    }
                }.start();
            }
        } catch (Exception e) {
            log.error("监控流程状态时间节点未生成Job异常：{}", e.getMessage(), e);
        }
    }

    private void process(AlarmDefinition alarmDefinition) {
        System.out.println("告警定义的类型："+alarmDefinition.getAlarmType());

        // 1.获取并计算时间段，取该时间段内的数据
        Date endTime = new Date();
        int intervalTime = adminAggrManager.getConfigParameterValue(ConfigParameterConstant.WorkflowProcess_TimestampItemNotCreated_CHECKING_INTERVAL, 1);
        Date startTime = DateUtil.addMinute(endTime, -intervalTime);
        String startTimeStampStr = BafDateUtils.formatTimestamp(startTime);
        String endTimeStampStr = BafDateUtils.formatTimestamp(endTime);

        System.out.println("查询间隔是" + intervalTime + "分钟；时间区间：" + startTimeStampStr + "--" + endTimeStampStr);

        // 2.获取OUT节点列表:根据itemCode和recordTime以及createdOn不为null
        String outSql = "Select workFlowId, recordTime From bl_time_record_item Where itemCode = 'outEmergencyDate' and recordTime >='" + startTimeStampStr + "' and recordTime <='" + endTimeStampStr
                + "' and recordTime is not null";
        List<Map<String, Object>> outItemList = bmfOrmAggrManager.builder(jdbcTemplate).queryForList(outSql);
        // 有OUT节点，存入缓存，然后期待30分钟内有CUU节点信息：
        if (CollectionUtils.isNotEmpty(outItemList)) {
            for (Map<String, Object> itemMap : outItemList) {
                long workFlowIdOfOut = (long) itemMap.get("workFlowId"); // 工作流ID:JdbcType:bigint
                Date recordTimeOfOut = (Date) itemMap.get("recordTime");// 日期:JdbcType:varchar

                System.out.println("OUT列表中的workFlowIdOfOut:"+workFlowIdOfOut+";recordTimeOfOut:"+recordTimeOfOut);

                // 从缓存中获取数据
                Date outEmergencyDate = (Date) redisTemplate.opsForHash().get("outEmergencyDate", workFlowIdOfOut);
                if (outEmergencyDate == null) {
                    // 缓存中没有该workFlowId,就存入缓存
                    redisTemplate.opsForHash().put("outEmergencyDate", workFlowIdOfOut, recordTimeOfOut);
                } else {

                    System.out.println("从缓存中获取的数据:"+outEmergencyDate);
                    // 有了，去执行触发脚本:
                    // 根据缓存去获取 CCU节点列表
                    String ccuSql = "Select workFlowId, recordTime From bl_time_record_item Where itemCode = 'ccuArrivalDate' and recordTime >='" + startTimeStampStr + "' and recordTime <='" + endTimeStampStr
                            + "' and workFlowId = " + workFlowIdOfOut + " and recordTime is not null order by recordTime ASC";
                    List<Map<String, Object>> ccuItemList = bmfOrmAggrManager.builder(jdbcTemplate).queryForList(ccuSql);

                    if (CollectionUtils.isNotEmpty(ccuItemList)) {
                        // 查到该OUT对应的CCU，比较时间:
                        // 获取最早的一条记录，，
                        Date firstRecordTimeOfCCU = (Date) ccuItemList.get(0).get("recordTime");
                        // 如果最早的一条满足条件，报警
                        if (DateUtil.addMinute(outEmergencyDate, 4).before(firstRecordTimeOfCCU)) {

                            AlarmRecordEntity alarmRecordEntity = new AlarmRecordEntity();
                            alarmRecordEntity.setObjectCode(String.valueOf(workFlowIdOfOut)); // 将workFlowId当做 ObjectCode
                            alarmRecordEntity.setObjectType("workFlow"); // 暂定为workFlow
                            alarmRecordEntity.setAlarmStatus("Created");
                            alarmRecordEntity.setSendStatus(0);
                            alarmRecordEntity.setAlarmSource("NODATE");
                            alarmRecordEntity.setAlarmStartTime(endTime);
                            alarmRecordEntity.setAlarmEndTime(endTime);
                            boolean flag = alarmService.addAlarmRecord(alarmDefinition, alarmRecordEntity);;

                            System.out.println("满足条件，生成告警记录"+flag+"，并发送邮件");

                            // 清除缓存
                            redisTemplate.opsForHash().delete("outEmergencyDate", workFlowIdOfOut);
                        }
                    } else {
                        // 与当前时间比是否过了30分钟:
                        if (DateUtil.addMinute(outEmergencyDate, 4).before(new Date())) {
                            System.out.println("此次Scan尚未发现CCU节点,但时间已超过30分钟");
                            // 清除缓存
                            redisTemplate.opsForHash().delete("outEmergencyDate", workFlowIdOfOut);
                        }
                    }
                }
            }
        }
    }

    @Override
    public List<String> getMissedJobs(Long jobId) {
        //List<String> jobKeys = Lists.newArrayList();

        getLastSuccessJobInstKey(jobId);
        return null;
    }

    private String getLastSuccessJobInstKey(Long jobId) {
        OrmUtilities.modifyBegin();
        BafJobOrmService bafJobOrmService = AiafContext.getBean(BafJobOrmService.class);
        BafJob bafJob = bafJobOrmService.findOneById(jobId);
        String result = bafJob == null ? null : bafJob.getLastSuccessJobKey();
        OrmUtilities.modifyEnd();

        return result;
    }

}

```

##修正版：

```java
package com.mdiaf.monitor.job;

import com.mdiaf.baf.AiafContext;
import com.mdiaf.batch.service.BafJobCommand;
import com.mdiaf.bmf.SObject;
import com.mdiaf.bmf.service.BmfOrmAggrManager;
import com.mdiaf.monitor.constant.ConfigParameterConstant;
import com.mdiaf.monitor.entity.AlarmRecordEntity;
import com.mdiaf.monitor.enums.AlarmTypeEnums;
import com.mdiaf.monitor.genmodel.AlarmDefinition;
import com.mdiaf.monitor.service.AlarmService;
import com.mdiaf.orm.service.BafJobOrmService;
import com.mdiaf.orm.service.util.OrmUtilities;
import com.mdiaf.pas.service.AdminAggrManager;
import com.mdiaf.recon.genmodel.BafJob;
import com.mdiaf.util.BafDateUtils;
import com.mdiaf.util.LogType;
import com.mdiaf.webapp.util.DateUtil;
import org.apache.commons.collections.CollectionUtils;
import org.apache.commons.collections.MapUtils;
import org.apache.commons.lang3.StringUtils;
import org.quartz.JobExecutionContext;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Component;

import java.io.Serializable;
import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.Set;

@Component
public class MonitorTimestampItemRecognitionErrorScanJobRevisedVersion implements BafJobCommand {


    @Autowired
    private AlarmService alarmService;

    @Autowired
    private AdminAggrManager adminAggrManager;

    @Autowired
    private BmfOrmAggrManager bmfOrmAggrManager;

    @Autowired
    private RedisTemplate<Serializable, Serializable> redisTemplate;

    private final Logger log = LoggerFactory.getLogger(LogType.JOB);

    @Autowired
    private JdbcTemplate jdbcTemplate;

    @Override
    public String getJobInstKey(Object jobParameters, SObject jobId) throws Exception {
        if (StringUtils.isNotEmpty((String) jobParameters)) { //Should of format yyyy-MM-dd
            //jobTime = BafDateUtils.parseDate((String) jobParameters);
            return (String) jobParameters;
        }

        Date jobTime = new Date();

        String currentJobEndTime = BafDateUtils.formatDate(jobTime, BafDateUtils.SYS_DEFAULT_DATE_FORMAT_STRING2);

        return currentJobEndTime;
    }

    @Override
    public void execute(JobExecutionContext context) throws Exception {
        try {
            List<AlarmDefinition> alarmDefinitionList = alarmService.getAlarmDefinitionListByAlarmType(AlarmTypeEnums.TimestampItemRecognitionError);
            for (final AlarmDefinition alarmDefinition : alarmDefinitionList) {
                new Thread(alarmDefinition.getAlarmCode()) {
                    public void run() {
                        log.debug("Thread: " + getName() + "running");
                        process(alarmDefinition);
                    }
                }.start();
            }
        } catch (Exception e) {
            log.error("监控流程状态时间节点未生成Job异常：{}", e.getMessage(), e);
        }
    }

    private void process(AlarmDefinition alarmDefinition) {
        System.out.println("告警定义的类型：" + alarmDefinition.getAlarmType());

        // 1.获取并计算时间段，取该时间段内的数据
        Date endTime = new Date();
        int intervalTime = adminAggrManager.getConfigParameterValue(ConfigParameterConstant.WorkflowProcess_TimestampItemNotCreated_CHECKING_INTERVAL, 1);
        Date startTime = DateUtil.addMinute(endTime, -intervalTime);
        String startTimeStampStr = BafDateUtils.formatTimestamp(startTime);
        String endTimeStampStr = BafDateUtils.formatTimestamp(endTime);

        System.out.println("查询间隔是" + intervalTime + "分钟；时间区间：" + startTimeStampStr + "--" + endTimeStampStr);

        // 2.获取OUT节点列表:根据itemCode和recordTime以及createdOn不为null
        String outSql = "Select workFlowId, recordTime From bl_time_record_item Where itemCode = 'outEmergencyDate' and recordTime >='" + startTimeStampStr + "' and recordTime <='" + endTimeStampStr
                + "' and recordTime is not null";
        List<Map<String, Object>> outItemList = bmfOrmAggrManager.builder(jdbcTemplate).queryForList(outSql);
        // 有OUT节点，存入缓存，然后期待30分钟内有CUU节点信息：
        if (CollectionUtils.isNotEmpty(outItemList)) {
            for (Map<String, Object> itemMap : outItemList) {
                long workFlowIdOfOut = (long) itemMap.get("workFlowId"); // 工作流ID:JdbcType:bigint
                Date recordTimeOfOut = (Date) itemMap.get("recordTime");// 日期:JdbcType:varchar

                System.out.println("OUT列表中的workFlowIdOfOut:" + workFlowIdOfOut + ";recordTimeOfOut:" + recordTimeOfOut);

                // 从缓存中获取数据
                Date outEmergencyDate = (Date) redisTemplate.opsForHash().get("outEmergencyDate", workFlowIdOfOut);
                if (outEmergencyDate == null) {
                    // 缓存中没有该workFlowId,就存入缓存
                    redisTemplate.opsForHash().put("outEmergencyDate", workFlowIdOfOut, recordTimeOfOut);
                }
            }
        }

        // 后置脚本:
        String ccuSql = "Select workFlowId, recordTime From bl_time_record_item Where itemCode = 'ccuArrivalDate' and recordTime >='" + startTimeStampStr + "' and recordTime <='" + endTimeStampStr
                + "' and recordTime is not null ";
        List<Map<String, Object>> ccuItemList = bmfOrmAggrManager.builder(jdbcTemplate).queryForList(ccuSql);

        // 查询所有wk还是查询一条WK
        if (CollectionUtils.isNotEmpty(ccuItemList)) {
            for (Map<String, Object> ccuMap : ccuItemList) {
                Long workFlowId = (Long) ccuMap.get("workFlowId"); // 工作流Id
                Date recordTime = (Date) ccuMap.get("recordTime"); // 最终记录时间

                Date recordTimeFromCache = (Date) redisTemplate.opsForHash().get("outEmergencyDate", workFlowId);
                // OUT与CCU匹配
                if (recordTimeFromCache != null) {
                    // 已生成且超时
                    if (DateUtil.addMinute(recordTimeFromCache, 30).before(recordTime)) {
                        AlarmRecordEntity alarmRecordEntity = new AlarmRecordEntity();
                        alarmRecordEntity.setObjectCode(String.valueOf(workFlowId)); // 将workFlowId当做 ObjectCode
                        alarmRecordEntity.setObjectType("workFlow"); // 暂定为workFlow
                        alarmRecordEntity.setAlarmStatus("Created");
                        alarmRecordEntity.setSendStatus(0);
                        alarmRecordEntity.setAlarmSource("NODATE");
                        alarmRecordEntity.setAlarmStartTime(endTime);
                        alarmRecordEntity.setAlarmEndTime(endTime);
                        boolean flag = alarmService.addAlarmRecord(alarmDefinition, alarmRecordEntity);

                        System.out.println("满足条件，生成告警记录" + flag + "，并发送邮件");
                        // 清除缓存
                        redisTemplate.opsForHash().delete("outEmergencyDate", workFlowId);
                    }
                }
            }
        } else {
            // 未生成CCU节点:判断是否属于 ：未生成且超时情况
            Date now = new Date();
            // 遍历缓存中的记录
            Map<Object, Object> allOutEmergencyDateCache = redisTemplate.opsForHash().entries("outEmergencyDate");
            if (MapUtils.isNotEmpty(allOutEmergencyDateCache)) {
                Set<Map.Entry<Object, Object>> entries = allOutEmergencyDateCache.entrySet();
                for (Map.Entry<Object, Object> entry : entries) {
                    Long workFlowIdFromCache = (Long) entry.getKey();
                    Date recordTimeFromCache = (Date) entry.getValue();
                    // 超时未生成
                    if (DateUtil.addMinute(recordTimeFromCache,30).before(now)){
                        // 业务逻辑代码
                        System.out.println("未生成但超时");
                        // 清除缓存
                        redisTemplate.opsForHash().delete("outEmergencyDate",workFlowIdFromCache);
                    }
                }
            }
        }
    }

    @Override
    public List<String> getMissedJobs(Long jobId) {
        //List<String> jobKeys = Lists.newArrayList();

        getLastSuccessJobInstKey(jobId);
        return null;
    }

    private String getLastSuccessJobInstKey(Long jobId) {
        OrmUtilities.modifyBegin();
        BafJobOrmService bafJobOrmService = AiafContext.getBean(BafJobOrmService.class);
        BafJob bafJob = bafJobOrmService.findOneById(jobId);
        String result = bafJob == null ? null : bafJob.getLastSuccessJobKey();
        OrmUtilities.modifyEnd();

        return result;
    }

}

```

##脚本：

```JAVA
         String outSql = "Select workFlowId, recordTime From bl_time_record_item Where itemCode = 'outEmergencyDate' and recordTime >='" + startTimeStampStr + "' and recordTime <='" + endTimeStampStr
                + "' and recordTime is not null";

        List<Long> workFlowIdList = new ArrayList<>();

        List<Map<String, Object>> outItemList = bmfOrmAggrManager.builder(jdbcTemplate).queryForList(outSql);
        if (CollectionUtils.isNotEmpty(outItemList)) {
            for (Map<String, Object> itemMap : outItemList) {
                long workFlowIdOfOut = (long) itemMap.get("workFlowId"); 
                Date recordTimeOfOut = (Date) itemMap.get("recordTime");
                Date outEmergencyDate = (Date) redisTemplate.opsForHash().get("outEmergencyDate", workFlowIdOfOut);
                if (outEmergencyDate == null) {
                    redisTemplate.opsForHash().put("outEmergencyDate", workFlowIdOfOut, recordTimeOfOut);
                } else {
                    workFlowIdList.add(workFlowIdOfOut);
                }
            }

            return 


        }

/* 前置脚本：
    获取outEmergencyDate节点列表，如果isNotEmpty()
        true：
            1.遍历列表，根据workFlowId判断缓存：
                1.无缓存，新增；
                2.有缓存，每一次循环将workFlowId和缓存中的时间 存入Map中
            2.循环结束后，返回Map
        false:
            1.返回null
*/
    String outSql = "Select workFlowId, recordTime From bl_time_record_item Where itemCode = 'outEmergencyDate' and recordTime >='" + startTimeStampStr + "' and recordTime <='" + endTimeStampStr
               + "' and recordTime is not null";
    List<Map<String, Object>> outItemList = bmfOrmAggrManager.builder(jdbcTemplate).queryForList(outSql);

    Map<Long,Date> resultMap = new HashMap<>();
    if (CollectionUtils.isNotEmpty(outItemList)) {
        for (Map<String, Object> itemMap : outItemList) {
            long workFlowIdOfOut = (long) itemMap.get("workFlowId");
            Date recordTimeOfOut = (Date) itemMap.get("recordTime");
            Date outEmergencyDate = (Date) redisTemplate.opsForHash().get("outEmergencyDate", workFlowIdOfOut);
            if (outEmergencyDate == null) {
                redisTemplate.opsForHash().put("outEmergencyDate", workFlowIdOfOut, recordTimeOfOut);
            } else {
                resultMap.put(workFlowIdOfOut,outEmergencyDate);
            }
        }
        return resultMap;
    }

    return null;

/*后置脚本：
    程序中，根据前置脚本执行结果，进行判断：
        将结果强转为Map ,如果MaP ！= null && map.size()>0 ；
            1.绑定变量
            2.执行后置脚本：
        后置脚本内容：
            遍历绑定的Map:
                1.获取workFlowId(key) 和 recordTimeFromCache（value）
                2.根据workFlowId 和 itemCode 及时间区间 获取CCU列表,并判断isNotEmpty（）：
                    true:
                        1.CCU记录中有和OUT对应的记录，获取最早的一条记录
                        2.时间判断： CCU-OUT>=30
                            true:
                                持久化，发送告警，清除这个workFlowId的缓存
                            false：
                                说明当前时间段，OUT对应的CCU节点记录尚未生成，判断OUT节点的时间:
                                OUT节点的recordTime +30m < 当前时间：
                                    true：
                                        1.清除workFlowId缓存
                                        2.业务逻辑

*/


       Map<Long,Date> preResultMap = null;

       Set<Long> workFlowIdSet = preResultMap.keySet();
       for (Long workFlowId : workFlowIdSet) {
           Date recordTimeFromCache = preResultMap.get(workFlowId); // 缓存中的时间
           String ccuSql = "Select workFlowId, recordTime From bl_time_record_item Where itemCode = 'ccuArrivalDate' and recordTime >='" + startTimeStampStr + "' and recordTime <='" + endTimeStampStr
                   + "' and workFlowId = " + workFlowId + " and recordTime is not null order by reportTime ASC";
           List<Map<String, Object>> ccuItemList = bmfOrmAggrManager.builder(jdbcTemplate).queryForList(ccuSql);

           if (CollectionUtils.isNotEmpty(ccuItemList)){
               // 获取最早的一条记录，，
               Date firstRecordTimeOfCCU = (Date) ccuItemList.get(0).get("recordTime");

               if (DateUtil.addMinute(recordTimeFromCache, 30).before(firstRecordTimeOfCCU)) {

                   AlarmRecordEntity alarmRecordEntity = new AlarmRecordEntity();
                   alarmRecordEntity.setObjectCode(String.valueOf(workFlowId)); // 将workFlowId当做 ObjectCode
                   alarmRecordEntity.setObjectType("workFlow"); // 暂定为workFlow
                   alarmRecordEntity.setAlarmStatus("Created");
                   alarmRecordEntity.setSendStatus(0);
                   alarmRecordEntity.setAlarmSource("NODATE");
                   alarmRecordEntity.setAlarmStartTime(BafDateUtils.parseDateByPattern(endTimeStampStr,BafDateUtils.DEFAULT_TIMESTAMP_FORMAT_STRING));
                   alarmRecordEntity.setAlarmEndTime(BafDateUtils.parseDateByPattern(endTimeStampStr,BafDateUtils.DEFAULT_TIMESTAMP_FORMAT_STRING));

                   alarmService.addAlarmRecord(alarmDefinition, alarmRecordEntity);

                   // 清除缓存
                   redisTemplate.opsForHash().delete("outEmergencyDate", workFlowId);
               }
           }else{
                   redisTemplate.opsForHash().delete("outEmergencyDate", workFlowId);
           }

       }


       OUT节点第一次产生时，只会存入缓存

       下一次，才会去判断是否满足告警


手环位点：
    每分钟的1秒开始执行
    每次


测试数据：
    



```

